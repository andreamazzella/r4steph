
# Comparing Two Categorical Variables: Practical 10

In this practical we focus on investigating the association between two categorical variables. We commence in the same way as the previous practical, loading libraries, setting options and themes, and reading in the data.


```{r, results = FALSE, warning = FALSE, message = FALSE}
#--- Load libraries
library(tidyverse)
library(epiDisplay)
library(foreign)
library(psych)

#--- Change to show no scientific notation & round to 3 decimal places
options(scipen = 10, digits=3) 

#--- Set the plot theme to come out in black and white
theme_set(theme_bw())

#--- Read in the file
bab9 <- read.dta("./BAB9.dta", convert.factors = T) 
```

## Two-way frequency tables

We start by asking if birthweight (outcome) is associated with hypertension in the mother (exposure). To do this, we will want to group birthweight into two categories. Usually this categorisation of variables is not recommended as you lose information about variability in the dataset by doing so. However, in this case, there is a clinical definition of low birthweight, being <2500g, that may have real world relevance. We use **dplyr** commands from the **tidyverse** to generate this new variable, specifically mutate().

```{r, warnings = F, message = F}
#--- Generate low birth weight variable
bab9 <- bab9 %>% mutate(lbw = ifelse(bweight < 2500, "low", "normal"))
```

Let's briefly unpack this code. We pipe bab9 into the mutate() command to indicate we are working with the bab9 dataset. The mutate() command says we will create a new variable. We say that this new variable will be called lbw (low birthweight) and use an ifelse() statement to generate it. The ifelse statement says that _if_ birthweight is less than 2500g, then lbw should take the value "low", _else_ it should take the value "normal". Note that we do not need to generate variables and then label them as we do in Stata - R automatically detects that you are creating a factor (categorical) variable with two levels. Finally, we overwrite the original bab9 datafile with our new bab9 datafile that includes the created lbw variable. Note what has changed in the Environment pane.

The 2x2 frequency table and odds ratio calculations (including a chi-squared test and a Fisher's exact test for the null hypothesis that there is no association between the two variables) can be generated by the command cc() in the epiDisplay package with the option graph = F. 

```{r}
#--- 2x2 table with OR
cc(bab9$ht, bab9$lbw, graph = F)
```

```{block2, type='rmdexercise2'}
Exercise 10.1: From this table, how many low birthweight babies were born to women with hypertension? How many low birthweight babies were born to women with no hypertension?
```

```{block2, type='rmdexercise2'}
Exercise 10.3: What is your interpretation of the chi-squared test?
```
---

The epiDisplay command tabpct() also provides both row and column percentages for 2x2 tables. Note that the outcome variable has been put first, with the exposure variable second.

```{r}
#--- 2x2 table with OR and percentages
tabpct(bab9$ht, bab9$lbw, graph = F)
```


```{block2, type='rmdexercise2'}
Exercise 10.2: What proportion of babies born to women who were hypertensive were of low birthweight? How
does this compare with the proportion of low birthweight babies born to women who were not hypertensive?
```


## Z-test for proportions

To carry out a z test to compare two proportions, we can use the prop.test() command, equivalent to _prtest_ in Stata. It is however, slightly more finicky to use. prop.test() requires two inputs: a vector of 'successes' (numerator) and a vector of 'counts' (denominator). A 'vector' in R is a sequence of objects that are of the same type (i.e. numerical or character...) - it is similar to a 'list', but a list may contain objects of any data type. 

You will thus need to manually extract these vectors from the output of the 2x2 table. For example, the vector of 'successes' (hypertension = yes) for these data is c(27, 62). The c() function creates a vector, the c standing for concatenate. The test is below, invoking the correct = F option to suppress the default behaviour of R of adding a continuity correction. 

Note that R does not provide the z score, but it can be derived by noting that the z score is the square root of the chi square -- the cc() command is much less work than running the actual test - thus demonstrating the utility of user-built packages! In the environment pane, we can click on the ztest object and look at the other objects contained within it - one of which is 'statistic'. We use the $ symbol to index statistic. Try and extract the p value from the test using this indexing strategy.

```{r}
#--- Run a z test
ztest <- prop.test(c(27, 53), n = c(89, 552), correct = F)
ztest

#--- Extract the z statistic
sqrt(ztest$statistic)
```

## Linear trends in proportions

Since birthweight is known to increase with length of gestation, we will use this fact to test for a linear trend in proportions. Gestational age was measured to the nearest week. 

Categorising a continuous variable always results in a loss of information and should generally be avoided unless there is a strong a priori reason to categorise it. However, categorising data may be useful for visualisation or for initial analyses to understand the data. Using internationally defined categories (such as < 2500g for birthweight) or categories informed by prior literature is always recommended.

Let's examine the histogram for gestational age.

```{r, warning = F, message = F}
#--- Plot gestational age
bab9 %>% ggplot(aes(x = gestwks)) + geom_histogram()
```

We notice that here we have left skew. This means that if we categorised the data by dividing gestwks into equally spaced groups of time (i.e. groups of 3.5 weeks) we would end up with unequal groups. So instead, we put an equal number of individuals into each group using the ntile() command and convert it to a factor. 

```{r}
#--- Get the quintiles
bab9$gest5 <- as.factor(ntile(bab9$gestwks, 5))

summary(bab9$gest5)

#--- Extract the top of each quintile (and thus the cut points)
bab9 %>% group_by(gest5) %>% summarise(max(gestwks))

#--- Examine gestational age by quintile
describeBy(bab9$gestwks, bab9$gest5)

#--- 
```


## Further exercises

